<!-- mcc-analytics.component.html (фрагмент таблицы) -->
<header class="toolbar">
    <div class="filters">
      <label class="date">
        <span>From</span>
        <input type="date" [value]="from()" (change)="setFrom($event)" />
      </label>
      <label class="date">
        <span>To</span>
        <input type="date" [value]="to()" (change)="setTo($event)" />
      </label>

      <div class="mcc-input">
        <span>MCC</span>
        <div class="chips">
          <button class="chip" *ngFor="let n of mccList()" (click)="mccRemove(n)" title="Remove">{{ n }}</button>
          <input type="text" mcc placeholder="e.g. 5411 5499, 5814" [value]="mccInput()" (change)="mccChipAdd($event)" />
          <!-- <button class="btn sm" (click)="mccChipAdd(mcc.value)">Add</button> -->
          <button class="btn sm ghost" (click)="mccClear()" *ngIf="mccList().length">Clear</button>
        </div>
      </div>

      <button class="btn primary" (click)="fetch()">Apply</button>
    </div>

    <div class="right-tools">
      <input class="search" type="search" placeholder="Search MCC or merchant..." [value]="search()" (change)="setSearch($event)" />
      <button class="btn" (click)="exportCsv()" title="Export current view to CSV">Export CSV</button>
    </div>
  </header>
<div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th (click)="setSort('mcc')">MCC</th>
          <th>Label</th>
          <th (click)="setSort('txCount')">Tx</th>
          <th (click)="setSort('totalSpent')">Σ Spent</th>
          <th (click)="setSort('totalIncome')">Σ Income</th>
          <th (click)="setSort('net')">Net</th>
          <th (click)="setSort('avgAbs')">Avg</th>
          <th>Top merchants</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let r of rows(); let i = index">
          <!-- основная строка -->
          <tr class="row" (click)="openTrendForMcc({ mcc: r.mcc, label: mccName(r.mcc) })">
            <td class="mono">{{ r.mcc }}</td>
            <td [title]="mccName(r.mcc)">{{ mccName(r.mcc) }}</td>
            <td class="mono">{{ r.txCount }}</td>
            <td class="mono neg">{{ formatUAH(r.totalSpent) }}</td>
            <td class="mono pos">{{ formatUAH(r.totalIncome) }}</td>
            <td class="mono" [class.neg]="r.net<0" [class.pos]="r.net>0">{{ formatUAH(r.net) }}</td>
            <td class="mono">{{ formatUAH(r.avgAbs) }}</td>
            <td class="tops">
              <button class="pill" *ngFor="let t of r.topMerchants"
                      (click)="$event.stopPropagation(); openTrendForMerchant(t.name)"
                      [title]="t.name + ' ' + (t.total | number:'1.0-2')">
                {{ t.name }} ({{ t.total | number:'1.0-2' }})
              </button>
            </td>
          </tr>
  
          <!-- выпадающая панель сразу под строкой -->
          <tr class="trend-row" *ngIf="expandedKey() === ('mcc:' + r.mcc)">
            <td colspan="8">
              <div class="trend-inline" [class.loading]="trendLoading">
                <div class="trend-inline__header">
                  <strong>{{ selectedTrendLabel }}</strong>
                  <span class="muted">помесячная динамика</span>
                  <div class="spacer"></div>
                  <button class="btn sm ghost" (click)="clearTrend()">Закрыть ×</button>
                </div>
  
                <!-- прогресс -->
                <div class="progress" *ngIf="trendLoading">
                  <div class="bar" [style.width.%]="trendPercent()"></div>
                  <div class="progress__text">
                    {{ trendCurrent() }}/{{ trendTotal() }} ({{ trendPercent() | number:'1.0-0' }}%)
                  </div>
                </div>
  
                <div style="display: flex;">
                    <!-- сам график -->
                    <app-chart
                        [label]="selectedTrendLabel"
                        [type]="ChartType.Expenses"
                        [mode]="'monthly'"
                        [monthly]="monthlyTrend"
                        [period]="period()"
                        [minorUnits]="false"
                        [currency]="'грн'">
                    </app-chart>

                    <app-chart
                        [label]="selectedTrendLabel"
                        [type]="ChartType.Income"
                        [mode]="'monthly'"
                        [monthly]="monthlyTrend"
                        [period]="period()"
                        [minorUnits]="false"
                        [currency]="'грн'">
                    </app-chart>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
  